name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache-dependency-path: go.sum

      # Cache the envtest k8s binaries (etcd + kube-apiserver, ~100 MB).
      # Key includes OS, arch, and k8s version so a version bump auto-invalidates.
      - name: Cache envtest binaries
        uses: actions/cache@v4
        with:
          path: bin/k8s
          key: envtest-1.28.0-${{ runner.os }}-${{ runner.arch }}

      # Cache controller-gen and setup-envtest binaries separately so that
      # a k8s version bump doesn't force a re-download of the tools.
      - name: Cache build tools
        uses: actions/cache@v4
        with:
          path: |
            bin/controller-gen
            bin/setup-envtest
          key: tools-${{ runner.os }}-${{ runner.arch }}-${{ hashFiles('go.sum') }}

      - name: Check formatting
        run: |
          unformatted=$(gofmt -l .)
          if [ -n "$unformatted" ]; then
            echo "The following files are not gofmt-formatted:"
            echo "$unformatted"
            exit 1
          fi

      - name: Run tests
        run: make test

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage
          path: cover.out
          if-no-files-found: error
