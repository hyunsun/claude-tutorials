<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Helm Operator UI</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: system-ui, -apple-system, sans-serif; background: #f5f7fa; color: #333; }

    header {
      background: #1a1a2e; color: white; padding: 1rem 1.5rem;
      display: flex; align-items: center; justify-content: space-between;
    }
    header h1 { font-size: 1.2rem; font-weight: 600; letter-spacing: 0.5px; }

    #status-bar {
      display: flex; align-items: center; gap: 0.5rem;
      font-size: 0.8rem; padding: 0.25rem 0.6rem; border-radius: 999px;
      background: #444; color: #ccc; transition: background 0.3s;
    }
    #status-bar.live   { background: #1e7e34; color: white; }
    #status-bar.error  { background: #c82333; color: white; }
    #status-dot { width: 8px; height: 8px; border-radius: 50%; background: currentColor; }

    main { padding: 1.5rem; max-width: 1200px; margin: 0 auto; }

    .toolbar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
    .toolbar h2 { font-size: 1rem; font-weight: 600; color: #555; text-transform: uppercase; letter-spacing: 0.5px; }

    .btn {
      cursor: pointer; padding: 0.45rem 1rem; border: none; border-radius: 6px;
      font-size: 0.875rem; font-weight: 500; transition: opacity 0.15s;
    }
    .btn:hover { opacity: 0.85; }
    .btn-primary  { background: #4361ee; color: white; }
    .btn-secondary{ background: #e2e8f0; color: #333; }
    .btn-danger   { background: #e53e3e; color: white; }
    .btn-sm { padding: 0.3rem 0.65rem; font-size: 0.8rem; }

    .card { background: white; border-radius: 10px; box-shadow: 0 1px 4px rgba(0,0,0,0.08); overflow: hidden; }

    table { width: 100%; border-collapse: collapse; }
    thead th { background: #f8fafc; padding: 0.75rem 1rem; text-align: left; font-size: 0.78rem;
               text-transform: uppercase; letter-spacing: 0.5px; color: #666; border-bottom: 1px solid #e2e8f0; }
    tbody td { padding: 0.75rem 1rem; font-size: 0.875rem; border-bottom: 1px solid #f0f4f8; vertical-align: middle; }
    tbody tr:last-child td { border-bottom: none; }
    tbody tr:hover { background: #f8fbff; }

    .phase-badge {
      display: inline-block; padding: 0.2rem 0.55rem; border-radius: 999px;
      font-size: 0.75rem; font-weight: 600; text-transform: uppercase;
    }
    .phase-Ready       { background: #c6f6d5; color: #276749; }
    .phase-Failed      { background: #fed7d7; color: #9b2c2c; }
    .phase-Installing  { background: #fefcbf; color: #744210; }
    .phase-Upgrading   { background: #bee3f8; color: #2a4365; }
    .phase-Uninstalling{ background: #e9d8fd; color: #553c9a; }
    .phase-Unknown     { background: #e2e8f0; color: #4a5568; }

    #empty-row td { text-align: center; color: #aaa; padding: 2rem; }

    .actions { display: flex; gap: 0.4rem; }

    /* Modal */
    .modal-overlay {
      display: none; position: fixed; inset: 0;
      background: rgba(0,0,0,0.45); z-index: 100;
      align-items: center; justify-content: center;
    }
    .modal-overlay.open { display: flex; }
    .modal-box {
      background: white; border-radius: 12px; padding: 1.75rem;
      width: 520px; max-width: calc(100vw - 2rem); max-height: calc(100vh - 4rem); overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0,0,0,0.25);
    }
    .modal-box h2 { font-size: 1.1rem; margin-bottom: 1.25rem; }

    .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0.85rem; }
    .form-group { display: flex; flex-direction: column; gap: 0.3rem; }
    .form-group.full { grid-column: 1 / -1; }
    .form-group label { font-size: 0.8rem; font-weight: 500; color: #555; }
    .form-group input, .form-group textarea {
      border: 1px solid #d1d5db; border-radius: 6px; padding: 0.45rem 0.65rem;
      font-size: 0.875rem; outline: none; transition: border-color 0.15s;
      font-family: inherit;
    }
    .form-group input:focus, .form-group textarea:focus { border-color: #4361ee; }
    .form-group input:disabled { background: #f3f4f6; color: #999; }
    .form-group textarea { resize: vertical; min-height: 90px; font-family: monospace; font-size: 0.8rem; }
    .form-hint { font-size: 0.72rem; color: #999; }

    .modal-footer { display: flex; justify-content: flex-end; gap: 0.5rem; margin-top: 1.25rem; }

    #error-msg {
      display: none; background: #fff5f5; border: 1px solid #fed7d7;
      color: #9b2c2c; padding: 0.6rem 0.85rem; border-radius: 6px;
      font-size: 0.8rem; margin-top: 0.85rem;
    }
    #error-msg.show { display: block; }
  </style>
</head>
<body>

<header>
  <h1>Helm Operator</h1>
  <div id="status-bar">
    <span id="status-dot"></span>
    <span id="status-text">Connecting...</span>
  </div>
</header>

<main>
  <div class="toolbar">
    <h2>Helm Releases</h2>
    <button class="btn btn-primary" onclick="openCreate()">+ New Release</button>
  </div>

  <div class="card">
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Namespace</th>
          <th>Chart</th>
          <th>Version</th>
          <th>Target NS</th>
          <th>Phase</th>
          <th>Helm Rev</th>
          <th>Last Deployed</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="releases-body">
        <tr id="empty-row"><td colspan="9">Loading...</td></tr>
      </tbody>
    </table>
  </div>
</main>

<!-- Create / Edit Modal -->
<div class="modal-overlay" id="modal" onclick="onOverlayClick(event)">
  <div class="modal-box">
    <h2 id="modal-title">New Helm Release</h2>
    <form id="release-form" onsubmit="submitForm(event)">
      <div class="form-grid">
        <div class="form-group">
          <label>Name *</label>
          <input id="f-name" required placeholder="my-app" />
        </div>
        <div class="form-group">
          <label>Namespace *</label>
          <input id="f-namespace" required placeholder="default" value="default" />
        </div>
        <div class="form-group">
          <label>Chart *</label>
          <input id="f-chart" required placeholder="nginx" />
        </div>
        <div class="form-group">
          <label>Version *</label>
          <input id="f-version" required placeholder="15.0.0" />
        </div>
        <div class="form-group full">
          <label>Repo URL *</label>
          <input id="f-repoURL" required placeholder="https://charts.bitnami.com/bitnami" />
        </div>
        <div class="form-group">
          <label>Target Namespace *</label>
          <input id="f-targetNamespace" required placeholder="default" />
        </div>
        <div class="form-group">
          <label>Release Name</label>
          <input id="f-releaseName" placeholder="(defaults to CR name)" />
        </div>
        <div class="form-group full">
          <label>Values (JSON)</label>
          <textarea id="f-values" placeholder='{"replicaCount": 2}'></textarea>
          <span class="form-hint">Optional Helm values as a JSON object.</span>
        </div>
      </div>
      <div id="error-msg"></div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
        <button type="submit" class="btn btn-primary" id="submit-btn">Create</button>
      </div>
    </form>
  </div>
</div>

<script>
  // ---- State ----
  let releases = {};     // "namespace/name" -> HelmRelease object
  let editingKey = null; // null = create mode, string = edit mode

  // ---- Init ----
  async function init() {
    await loadAll();
    connectSSE();
  }

  async function loadAll() {
    try {
      const resp = await fetch('/api/helmreleases');
      if (!resp.ok) throw new Error(await resp.text());
      const items = await resp.json();
      releases = {};
      (items || []).forEach(hr => { releases[hrKey(hr)] = hr; });
      renderTable();
    } catch (e) {
      console.error('loadAll:', e);
    }
  }

  function hrKey(hr) {
    return `${hr.metadata.namespace}/${hr.metadata.name}`;
  }

  // ---- SSE ----
  function connectSSE() {
    const es = new EventSource('/api/events');

    es.onopen = () => setStatus('live', 'Live');

    es.onerror = () => setStatus('error', 'Disconnected — reconnecting...');

    es.onmessage = (e) => {
      let data;
      try { data = JSON.parse(e.data); } catch { return; }
      if (data.type === 'ping') return;
      if (!data.resource) return;

      const k = hrKey(data.resource);
      if (data.type === 'deleted') {
        delete releases[k];
      } else {
        releases[k] = data.resource;
      }
      renderTable();
    };
  }

  function setStatus(cls, text) {
    const bar = document.getElementById('status-bar');
    bar.className = cls;
    document.getElementById('status-text').textContent = text;
  }

  // ---- Render ----
  function renderTable() {
    const tbody = document.getElementById('releases-body');
    const items = Object.values(releases);

    if (items.length === 0) {
      tbody.innerHTML = '<tr id="empty-row"><td colspan="9">No HelmReleases found. Create one to get started.</td></tr>';
      return;
    }

    tbody.innerHTML = '';
    items.forEach(hr => {
      const phase = hr.status && hr.status.phase ? hr.status.phase : 'Unknown';
      const deployedAt = hr.status && hr.status.lastDeployedAt
        ? new Date(hr.status.lastDeployedAt).toLocaleString()
        : '—';
      const helmRev = hr.status && hr.status.helmRevision ? hr.status.helmRevision : '—';
      const k = hrKey(hr);
      const name = escHtml(hr.metadata.name);
      const ns = escHtml(hr.metadata.namespace);

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><strong>${name}</strong></td>
        <td>${ns}</td>
        <td>${escHtml(hr.spec.chart)}</td>
        <td>${escHtml(hr.spec.version)}</td>
        <td>${escHtml(hr.spec.targetNamespace)}</td>
        <td><span class="phase-badge phase-${escHtml(phase)}">${escHtml(phase)}</span></td>
        <td>${helmRev}</td>
        <td>${escHtml(deployedAt)}</td>
        <td>
          <div class="actions">
            <button class="btn btn-secondary btn-sm" onclick="openEdit('${k}')">Edit</button>
            <button class="btn btn-danger btn-sm" onclick="doDelete('${hr.metadata.name}', '${hr.metadata.namespace}')">Delete</button>
          </div>
        </td>`;
      tbody.appendChild(tr);
    });
  }

  function escHtml(s) {
    return String(s)
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;');
  }

  // ---- Modal ----
  function openCreate() {
    editingKey = null;
    document.getElementById('modal-title').textContent = 'New Helm Release';
    document.getElementById('submit-btn').textContent = 'Create';
    document.getElementById('release-form').reset();
    document.getElementById('f-namespace').value = 'default';
    setFieldsDisabled(false);
    hideError();
    document.getElementById('modal').classList.add('open');
  }

  function openEdit(k) {
    editingKey = k;
    const hr = releases[k];
    if (!hr) return;

    document.getElementById('modal-title').textContent = 'Edit Helm Release';
    document.getElementById('submit-btn').textContent = 'Save';

    document.getElementById('f-name').value = hr.metadata.name;
    document.getElementById('f-namespace').value = hr.metadata.namespace;
    document.getElementById('f-chart').value = hr.spec.chart;
    document.getElementById('f-repoURL').value = hr.spec.repoURL;
    document.getElementById('f-version').value = hr.spec.version;
    document.getElementById('f-targetNamespace').value = hr.spec.targetNamespace;
    document.getElementById('f-releaseName').value = hr.spec.releaseName || '';
    document.getElementById('f-values').value =
      hr.spec.values ? JSON.stringify(hr.spec.values, null, 2) : '';

    // name and namespace are immutable identifiers
    setFieldsDisabled(true);
    hideError();
    document.getElementById('modal').classList.add('open');
  }

  function closeModal() {
    document.getElementById('modal').classList.remove('open');
    setFieldsDisabled(false);
  }

  function onOverlayClick(e) {
    if (e.target === document.getElementById('modal')) closeModal();
  }

  function setFieldsDisabled(disabled) {
    document.getElementById('f-name').disabled = disabled;
    document.getElementById('f-namespace').disabled = disabled;
  }

  function showError(msg) {
    const el = document.getElementById('error-msg');
    el.textContent = msg;
    el.classList.add('show');
  }

  function hideError() {
    document.getElementById('error-msg').classList.remove('show');
  }

  // ---- CRUD ----
  async function submitForm(e) {
    e.preventDefault();
    hideError();

    const body = {
      name:            document.getElementById('f-name').value.trim(),
      namespace:       document.getElementById('f-namespace').value.trim(),
      chart:           document.getElementById('f-chart').value.trim(),
      repoURL:         document.getElementById('f-repoURL').value.trim(),
      version:         document.getElementById('f-version').value.trim(),
      targetNamespace: document.getElementById('f-targetNamespace').value.trim(),
      releaseName:     document.getElementById('f-releaseName').value.trim(),
      values:          document.getElementById('f-values').value.trim(),
    };

    // Validate JSON values if provided
    if (body.values) {
      try { JSON.parse(body.values); }
      catch { showError('Values field must be valid JSON.'); return; }
    }

    try {
      let resp;
      if (editingKey === null) {
        resp = await fetch('/api/helmreleases', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body),
        });
      } else {
        const params = new URLSearchParams({ name: body.name, ns: body.namespace });
        resp = await fetch(`/api/helmreleases?${params}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body),
        });
      }
      if (!resp.ok) {
        const text = await resp.text();
        showError(text || `Server error: ${resp.status}`);
        return;
      }
      closeModal();
      // SSE will push the update; fall back to full reload if SSE is disconnected
      await loadAll();
    } catch (err) {
      showError(err.message);
    }
  }

  async function doDelete(name, namespace) {
    if (!confirm(`Delete "${name}" in namespace "${namespace}"?\n\nThe Helm release will also be uninstalled.`)) return;
    try {
      const params = new URLSearchParams({ name, ns: namespace });
      const resp = await fetch(`/api/helmreleases?${params}`, { method: 'DELETE' });
      if (!resp.ok) {
        alert(`Delete failed: ${await resp.text()}`);
        return;
      }
      // Optimistically remove; SSE will confirm
      delete releases[`${namespace}/${name}`];
      renderTable();
    } catch (err) {
      alert(`Delete failed: ${err.message}`);
    }
  }

  init();
</script>
</body>
</html>
